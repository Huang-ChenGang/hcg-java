## 分布式事务

分布式对应的是单体架构。早起的架构里是在一个应用里进行ACID。
但是随着业务的复杂度提高，逐渐演变为了现在的分布式服务，服务间互相协作，每个服务负责不同的业务。
这种分布式系统环境下由不同的服务之间通过网络远程协作完成事务称之为分布式事务。
在Java里可以简言之：跨JVM进程产生分布式事务。

协调者和参与者说明：在分布式架构下，每个节点只知晓自己操作的失败或者成功，无法得知其他节点的状态。
当一个事务跨多个节点时，为了保持事务的原子性与一致性，而引入一个协调者来统一掌控所有参与者的操作结果，
并指示它们是否要把操作结果进行真正的提交或者回滚。

## CAP原则

### C：consistency：一致性

指强一致性，在写操作完成后开始的任何读操作都必须返回该值，或者后续写操作的结果。
也就是说，在一致性系统中，一旦客户端将值写入任何一台服务器并获得响应，那么之后client从其他任何服务器读取的都是刚写入的数据。
一致性保证了不管向哪台服务器写入数据，其他的服务器能实时同步数据。

### A：availability：可用性

可用性（高可用）是指：每次向未崩溃的节点发送请求，总能保证收到响应数据（允许不是最新数据）。

### P：partition tolerance：分区容忍性

分布式系统在遇到任何网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务。

CAP原则又叫CAP定理，指的是在一个分布式系统中，不可能同时满足CAP三点。
分布式系统注定要满足P，所以只能是CP或AP，也就是要在一致性和可用性中做选择。

## BASE理论

BASE理论是对CAP中的一致性和可用性进行一个权衡的结果，
理论的核心思想就是：我们无法做到强一致，但每个应用都可以根据自身的业务特点，
采用适当的方式来使系统达到最终一致性。

### BA：basic available：基本可用

整个系统在某些不可抗力的情况下，仍然能够保证“可用性”，
即一定时间内仍然能够返回一个明确的结果。这里是属于基本可用。

基本可用和高可用的区别：
- “一定时间”可以适当延长 当举行大促（比如秒杀）时，响应时间可以适当延长。
- 给部分用户返回一个降级页面 给部分用户直接返回一个降级页面，从而缓解服务器压力。但要注意，返回降级页面仍然是返回明确结果。

### S：soft state：柔性状态

称为柔性状态，是指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，
即允许系统不同节点的数据副本之间进行数据同步的过程存在延时。

### E：eventual consistency：最终一致性

同一数据的不同副本的状态，可以不需要实时一致，但一定要保证经过一定时间后仍然是一致的。

## 2PC：two-phase commit：二阶段提交

二阶段提交是常用的分布式事务解决方案，即将事务的提交过程分为两个阶段来进行处理。

两个阶段分别为：
- 准备阶段
- 提交阶段

参与的角色：
- 事务协调者（事务管理器）：事务的发起者
- 事务参与者（资源管理器）：事务的执行者

### 准备阶段

这是两阶段的第一段，这一阶段只是准备阶段，由事务的协调者发起询问参与者是否可以提交事务，
但是这一阶段并未提交事务，流程如下：
1. 协调者向所有参与者发送事务内容，询问是否可以提交事务，并等待答复。
2. 各参与者执行事务操作，将提交(redo)和撤销(undo)信息记入事务日志中（但不提交事务）。
3. 如参与者执行成功，给协调者反馈同意，否则反馈中止。

### 提交阶段

这一段阶段属于2PC的第二阶段（提交 执行阶段），协调者发起正式提交事务的请求，
当所有参与者都回复同意时，则意味着完成事务，流程如下：
1. 协调者节点向所有参与者节点发出正式提交的请求。
2. 参与者节点正式完成操作，并释放在整个事务期间内占用的资源。
3. 参与者节点向协调者节点发送完成消息。
4. 协调者节点收到所有参与者节点反馈的完成消息后，完成事务。

但是如果任意一个参与者节点在第一阶段返回的消息为终止，
或者协调者节点在第一阶段的询问超时之前无法获取所有参与者节点的响应消息时，
那么这个事务将会被回滚，回滚的流程如下：
1. 协调者节点向所有参与者节点发出回滚操作的请求。
2. 参与者节点利用阶段一写入的撤销(undo)信息执行回滚，并释放在整个事务期间内占用的资源。
3. 参与者节点向协调者节点发送回滚完成消息。
4. 协调者节点受到所有参与者节点反馈的回滚完成消息后，取消事务。

不管最后结果如何，第二阶段都会结束当前事务。

### 2PC缺点

- 性能问题：执行过程中，所有参与节点都是事务阻塞型的。
当参与者占有公共资源时，其他第三方节点访问公共资源不得不处于阻塞状态。
- 可靠性问题：参与者发生故障。协调者需要给每个参与者额外指定超时机制，超时后整个事务失败。
协调者发生故障。参与者会一直阻塞下去。需要额外的备机进行容错。
- 实现复杂：牺牲了可用性，对性能影响较大，不适合高并发高性能场景。

### 2PC优点

尽量保证了数据的强一致（其实也不能100%保证强一致）。