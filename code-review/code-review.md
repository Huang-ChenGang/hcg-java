## 如何做 CodeReview

以下内容出处：[如何做好CodeReview](https://juejin.cn/post/6844903944175484936)

名词解释：
- cr: code review
- cl: change list，指这次改动
- reviewer: 做 cr 的那个人
- nit: 全称 nitpick，意思是鸡蛋里挑骨头
- 作者: 也就是本次 cl 的开发者

### CodeReview 的标准

cr(Code review)主要目的在于确保代码库代码质量越来越好。而所有相关的工具与流程皆是因应这个目的而生。
为达到此目的，势必需要做出一连串的权衡与取舍。

首先，开发人员必须能够在自己负责的任务上有所进展。如果你从来没有向代码库提交改进过的代码，那么代码库就永远不会改进。
另外，如果一个 reviewer 使 cr 都很难进行的话，那么开发人员就不愿意在将来进行改进。

另一方面，reviewer 有责任确保每个 cl 的质量，保证其代码库的整体代码质量不会越来越差。
这可能很棘手，因为通常会随着时间的推移，代码需要降级才能让代码运行起来，
特别是当团队受到严重的时间限制时，大家觉得必须走捷径才能实现他们的目标。

此外，reviewer 对他们正在 review 的代码拥有所有权和责任。他们希望确保代码保持一致、可维护。

因此，我们有以下规则，作为我们在 cr 中所期望的标准：

一般来说，当 cl 存在的时候，reviewer 应该赞成它，此时它肯定会提高正在工作的系统的整体代码质量，即使这个 cl 并不完美。
这是所有 cr 中的首要原则。当然，这是有局限性的。例如，如果一个 cl 添加了一个 reviewer 不希望在其系统中使用的功能，
那么reviewer当然可以拒绝，即使代码设计得很好。

这里的一个关键点是，没有“完美”的代码，只有更好的代码。reviewer 不应该要求作者在 approve 之前对一篇文章的每一小段进行润色。
相反，reviewer 应该权衡发展的需要和他们所建议的 change 的重要性。reviewer 不应追求完美，而应追求持续改进。
作为一个整体，提高系统的可维护性、可读性和可理解性的 cl 不应该因为它不是“完美的”而被延迟几天或几周。

reviewer 应该随时可以留下评论，表达一些更好的东西，但如果不是很重要，可以在评论前加上“nit:”这样的前缀，
让作者知道这只是一个他们可以选择忽略的修饰点。

1. 指导

cr 有一个重要的功能，教开发人员一些关于语言、框架或一般软件设计原则的新知识。留下有助于开发人员学习新知识的评论是可以的。
随着时间的推移，共享知识是提高系统代码健康度的一部分。你只需要记住，如果你的评论纯粹是教育性的，但对达到本文档中描述的标准并不重要，
请在其前面加上“nit:”，或者以其他方式表明作者不必在本 cl 中解决它。

2. 原则

现实和数据推翻了个人喜好。在代码风格方面，只要不违反基本的代码规范，就别要求作者去更改代码风格。代码风格应该与现有的一致。
如果项目没有以前的统一风格，那就接受作者的风格。

软件设计的各个方面从来都不仅仅是一个纯粹的代码风格问题或者是个人喜好问题。
它们是以基本原则为基础的，应当以这些原则为依据，而不仅仅是以个人意见为依据，有时几乎都没有选择的。
如果作者能够证明（通过数据或基于原理的一些事实）他的方法是同样有效的，那么 reviewer 应该接受作者的偏好。
否则，代码风格选择取决于软件设计的标准原则。

如果没有其他规则适用，那么 reviewer 可以要求作者与当前代码库中的内容保持一致，只要这些代码不会恶化系统的整体代码健康状况。

3. 解决冲突

在 cr 的任何冲突中，第一步应该始终是开发人员和 reviewer 尝试达成共识。
当达成共识变得特别困难时，reviewer 和作者需要进行面对面会议，而不是仅仅试图通过cr的注释来解决冲突。
如果这样做，请确保将讨论结果记录在 cl 的评论中，以供将来的读者阅读。

如果这不能解决问题，最常见的解决方法就是升级。
通常情况下，升级的途径是进行更广泛的团队讨论，让 team leader 参与进来，请求代码维护人员做出决定，或者请求技术经理提供帮助。
不要因为作者和审稿人不能达成一致意见而让一个其他人袖手旁观。

### CodeReview 应该 review 些什么

1. 设计

在 cr 中重要的是看 cl 的总体设计。cl 中不同代码段的交互是否有意义？
此更改属于你的业务代码库还是属于引进来的其他代码库？它是否与系统的其他部分很好地集成？现在是添加此功能的合适时机吗？

2. 功能

这个 cl 做了开发者想要的吗？开发者对这些代码的设计初衷用户有好处吗？
“用户”通常既是最终用户（当他们受到更改的影响时）又是开发人员（他们将来必须“使用”此代码）。

大多数情况下，我们希望开发人员在进行 cr 时能够对 cl 进行充分的测试，使其能够正常工作。
但是，作为 reviewer，仍然应该考虑边缘状况，寻找问题，尝试像用户一样思考，并确保仅通过阅读代码就不会看到错误。

如果 reviewer 愿意的话，你可以自己去验证 cl。如果改动会直接带来的用户可见的影响，比如说 ui 改动，验证 cl 的变化是非常关键的。
在阅读代码时，很难理解某些更改会对用户产生怎样的影响。对于这样的更改，如果不方便自己测试，则可以让开发人员演示该功能(demo)。

另外，在 cr 期间考虑功能性特别重要的点是，cl 中是否并发式编程，理论上可能导致死锁或竞争条件。
这些类型的问题很难通过运行代码来发现，通常需要有人（开发人员和 reviewer ）仔细考虑，以确保不会引入问题。
（注意，这也是不使用平行式编程的一个很好的理由，在这种情况下，可能出现竞争条件或死锁，这会使代码检查或理解代码变得非常复杂。）

3. 复杂性

一个 cl 是否复杂到超过预期的必须？针对任何层级的 cl 必须确认这几点：单行代码是否过于复杂？函数是否过于复杂？
class 是否过于复杂？“复杂”通常意味着该代码很难阅读，很有可能也意味着其他开发者在修改这段代码的时候引入其他 bug。

其中一种复杂性就是过度设计(Over-engineering)造成的，开发者会让那段代码过度通用化，超过了原本所需，或者还新增了系统目前不需要的功能。
reviewer 应特别注意一下过度设计。鼓励开发者解决他们知道现在需要解决的问题，而不是推测将来可能需要解决的问题。
当那些将来出现的问题出现的时候才开始解决它们，因为那时候你可以更加清晰看见问题的原样子。
> Donald Knuth说过：过早的优化是万恶之源(Premature optimization is the root of all evil)

4. 测试

请将单元测试、整合测试、端到端测试视为要求 cl 所做的适当变更。一般 cl 内除了生产环境的业务代码外，测试也应该要被加入其中。
除非该 cl 是为了处理某个紧急事情而存在。

另外，也要确保测试是正确、合理、有用的。测试并非来测试它们本身，一般也极少为了测试而测试，因此我们要保证测试是有效的。

当代码真的有问题，测试是否会失败？如果被测试的程序发生改动时，测试是否会产生误报？
每一个测试是否做出了简单而有用的断言？不同的测试方法之间的测试是否适当分开？

**测试代码也是必须维护的代码，不要忽略测试代码。**

5. 命名

开发者是否为了每一个东西都挑了一个适当的名字？一个好的命名意味着，通过名字就足以完整表达该东西的作用是什么或者要做什么。
但是同时名字也不要长得难以阅读。